<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Admin panel</title>

    <link rel="stylesheet"
          href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar navbar-dark bg-dark px-3">

    <span class="navbar-brand text-white">
        <span sec:authentication="name"></span>
        with roles:
        <span th:each="role : ${#authentication.principal.authorities}"
              th:text="${#strings.replace(role.authority, 'ROLE_', '') + ' '}"></span>
    </span>

    <form th:action="@{/logout}" method="post" class="ml-auto">
        <button class="btn btn-dark text-secondary">Logout</button>
    </form>

</nav>

<div class="container-fluid">
    <div class="row">

        <!-- LEFT MENU -->
        <div class="col-md-2 bg-white pt-3">
            <div class="nav flex-column nav-pills">
                <a class="nav-link active" href="/admin">Admin</a>
                <a class="nav-link" href="/user">User</a>
            </div>
        </div>

        <!-- CONTENT -->
        <div class="col-md-10 bg-light pt-3">
            <h1>Admin panel</h1>

            <ul class="nav nav-tabs">
                <li class="nav-item">
                    <a class="nav-link active" data-toggle="tab" href="#users">Users table</a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-toggle="tab" href="#new">New User</a>
                </li>
            </ul>

            <div class="tab-content">
                <!-- USERS TABLE -->
                <div class="tab-pane fade show active" id="users">

                    <div class="card">

                        <div class="card-header bg-white">
                            <h5 class="mb-0">All users</h5>
                        </div>

                        <div class="card-body p-0">
                            <table class="table table-striped mb-0">
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>First Name</th>
                                    <th>Last Name</th>
                                    <th>Age</th>
                                    <th>Email</th>
                                    <th>Roles</th>
                                    <th>Edit</th>
                                    <th>Delete</th>
                                </tr>
                                </thead>
                                <tbody id="usersTableBody"></tbody>
                            </table>
                        </div>

                    </div>
                </div>

                <!-- ADD USER -->
                <div class="tab-pane fade" id="new">
                    <div class="card">
                        <div class="card-header bg-white">
                            <h5 class="mb-0">Add new user</h5>
                        </div>
                        <div class="card-body">
                            <form id="addUserForm">

                                <div class="mb-2 w-50">
                                    <label class="form-label d-block text-center fw-bold">First name</label>
                                    <input name="firstName" class="form-control" placeholder="First name" required>
                                </div>

                                <div class="mb-2 w-50">
                                    <label class="form-label d-block text-center fw-bold">Last name</label>
                                    <input name="lastName" class="form-control" placeholder="Last name" required>
                                </div>

                                <div class="mb-2 w-50">
                                    <label class="form-label d-block text-center fw-bold">Age</label>
                                    <input type="number" name="age" class="form-control" placeholder="Age" min="0" max="120">
                                </div>

                                <div class="mb-2 w-50">
                                    <label class="form-label d-block text-center fw-bold">Email</label>
                                    <input name="email" class="form-control" placeholder="Email" required>
                                </div>

                                <div class="mb-2 w-50">
                                    <label class="form-label d-block text-center fw-bold">Password</label>
                                    <input type="password" name="password" class="form-control" placeholder="Password" required>
                                </div>

                                <div class="mb-3 w-50">
                                    <label class="form-label d-block text-center fw-bold">Roles</label>
                                    <select id="rolesSelect" name="roles" multiple class="form-control">
                                        <option th:each="role : ${allRoles}"
                                                th:value="${role.id}"
                                                th:text="${role.name}">
                                        </option>
                                    </select>
                                </div>

                                <div class="text-center">
                                    <button class="btn btn-success">Add new user</button>
                                </div>

                            </form>
                        </div>
                    </div>
                </div>

                <!-- EDIT USER MODAL -->
                <div class="modal fade" id="editModal" tabindex="-1">
                    <div class="modal-dialog">
                        <div class="modal-content">

                            <div class="modal-header">
                                <h5 class="modal-title">Edit user</h5>
                                <button type="button" class="close" data-dismiss="modal">&times;</button>
                            </div>

                            <div class="modal-body">
                                <input type="hidden" id="editId">

                                <input id="editFirstName" class="form-control mb-2" placeholder="First name">
                                <input id="editLastName" class="form-control mb-2" placeholder="Last name">
                                <input id="editAge" type="number" class="form-control mb-2" placeholder="Age">
                                <input id="editEmail" class="form-control mb-2" placeholder="Email">
                                <input id="editPassword" type="password" class="form-control mb-2" placeholder="New password">

                                <label>Roles</label>
                                <select id="editRoles" multiple class="form-control"></select>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-primary" onclick="saveEdit()">Save</button>
                            </div>

                        </div>
                    </div>
                </div>

                <script>
                    document.addEventListener("DOMContentLoaded", loadUsers);

                    function loadUsers() {
                        fetch('/api/admin/users')
                            .then(res => res.json())
                            .then(users => {
                                const tbody = document.getElementById('usersTableBody');
                                tbody.innerHTML = '';
                                users.forEach(u => {
                                    tbody.innerHTML += `
                <tr>
                    <td>${u.id}</td>
                    <td>${u.firstName}</td>
                    <td>${u.lastName}</td>
                    <td>${u.age}</td>
                    <td>${u.email}</td>
                    <td>${u.roles.map(r => r.name).join(', ')}</td>
                    <td><button class="btn btn-info btn-sm" onclick="openEdit(${u.id})">Edit</button></td>
                    <td><button class="btn btn-danger btn-sm" onclick="deleteUser(${u.id})">Delete</button></td>
                </tr>`;
                                });
                            });
                    }
                </script>
                <script>
                    function deleteUser(id) {
                        fetch(`/api/admin/users/${id}`, {
                            method: 'DELETE'
                        }).then(() => loadUsers());
                    }
                </script>
                <script>
                    document.getElementById('addUserForm').addEventListener('submit', function(e) {
                        e.preventDefault();

                        const user = {
                            firstName: this.firstName.value,
                            lastName: this.lastName.value,
                            age: this.age.value,
                            email: this.email.value,
                            password: this.password.value,
                            roles: Array.from(this.roles.selectedOptions).map(o => ({id: o.value}))
                        };

                        fetch('/api/admin/users', {
                            method: 'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(user)
                        }).then(() => {
                            this.reset();
                            loadUsers();
                        });
                    });
                </script>
                <script>
                    function loadRoles() {
                        fetch('/api/admin/roles')
                            .then(res => res.json())
                            .then(roles => {
                                const select = document.getElementById('rolesSelect');
                                select.innerHTML = '';
                                roles.forEach(r => {
                                    select.innerHTML += `<option value="${r.id}">${r.name}</option>`;
                                });
                            });
                    }

                    document.addEventListener("DOMContentLoaded", loadRoles);
                </script>
            <script>
                function openEdit(id) {
                    Promise.all([
                        fetch('/api/admin/users').then(r => r.json()),
                        fetch('/api/admin/roles').then(r => r.json())
                    ]).then(([users, roles]) => {
                        const user = users.find(u => u.id === id);

                        editId.value = user.id;
                        editFirstName.value = user.firstName;
                        editLastName.value = user.lastName;
                        editAge.value = user.age;
                        editEmail.value = user.email;
                        editPassword.value = '';

                        const rolesSelect = document.getElementById('editRoles');
                        rolesSelect.innerHTML = '';
                        roles.forEach(role => {
                            const selected = user.roles.some(r => r.id === role.id);
                            rolesSelect.innerHTML += `<option value="${role.id}" ${selected ? 'selected' : ''}>${role.name}</option>`;
                        });

                        $('#editModal').modal('show');
                    });
                }
            </script>
            <script>
                function saveEdit() {
                    const user = {
                        firstName: editFirstName.value,
                        lastName: editLastName.value,
                        age: editAge.value,
                        email: editEmail.value,
                        password: editPassword.value,
                        roles: Array.from(editRoles.selectedOptions).map(o => ({id: o.value}))
                    };

                    fetch(`/api/admin/users/${editId.value}`, {
                        method: 'PUT',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify(user)
                    }).then(() => {
                        $('#editModal').modal('hide');
                        loadUsers();
                    });
                }
            </script>
</body>
</html>